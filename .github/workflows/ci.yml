name: Build & Release Wheels

# Trigger only for release tags (v*)
on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  test:
    name: Unit tests (fast gate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dev deps
        run: |
          pip install --upgrade pip pytest

      - name: Run tests
        working-directory: python
        run: pytest -q


  build-linux:
    name: Build wheels (Linux x64)
    runs-on: ubuntu-latest
    needs: test
    env:
      # ensure cibuildwheel runs linux builds
      CIBW_PLATFORM: linux
      # point to the Python project location (if pyproject.toml is under python/)
      CIBW_PROJECT_PATH: python
      # pre-build commands executed inside the manylinux build container
      # this will:
      #  - generate cmake config
      #  - build native libs (libmlc_llm.so etc)
      #  - ensure python packaging can include built libs
      CIBW_BEFORE_BUILD: |
        set -e
        # repo root is mounted in the container; build under /io (cibuildwheel uses /io by default)
        cd /io
        git submodule update --init --recursive || true
        mkdir -p build && cd build
        python ../cmake/gen_cmake_config.py
        cmake .. && make -j$(nproc)
        cd /io/python
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Docker Buildx (required by cibuildwheel manylinux flow)
        uses: docker/setup-buildx-action@v3
      - name: Install cibuildwheel (host helper)
        run: python -m pip install --upgrade pip cibuildwheel==2.* build
      - name: Build manylinux wheels via cibuildwheel
        # run cibuildwheel from repo root; it will use CIBW_PROJECT_PATH=python
        run: python -m cibuildwheel --output-dir wheelhouse
      - name: Upload linux wheels
        uses: actions/upload-artifact@v4
        with:
          name: linux-wheels
          path: wheelhouse/*.whl

  build-windows:
    name: Build wheels (Windows x64)
    runs-on: windows-latest
    needs: test
    env:
      CIBW_PLATFORM: windows
      CIBW_PROJECT_PATH: python
      # Pre-build command to run inside the windows build environment.
      # Use PowerShell syntax when running on Windows; on Windows runner cibuildwheel uses powershell by default.
      CIBW_BEFORE_BUILD: |
        $ErrorActionPreference = 'Stop'
        cd $env:GITHUB_WORKSPACE
        git submodule update --init --recursive
        if (-not (Test-Path build)) { New-Item -ItemType Directory -Path build | Out-Null }
        Push-Location build
        python ..\cmake\gen_cmake_config.py
        cmake .. 
        # build using MSBuild/make depending on env; cibuildwheel Windows runner provides MSVC toolchain
        cmake --build . --config Release -- /m
        Pop-Location
        cd python
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install cibuildwheel
        run: python -m pip install --upgrade pip cibuildwheel==2.* build
      - name: Build windows wheels via cibuildwheel
        run: python -m cibuildwheel --output-dir wheelhouse
      - name: Upload windows wheels
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheels
          path: wheelhouse/*.whl

  release:
    name: Create release and attach wheels
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
      - uses: actions/checkout@v4
      - name: Download linux wheels
        uses: actions/download-artifact@v4
        with:
          name: linux-wheels
          path: artifacts/wheels
      - name: Download windows wheels
        uses: actions/download-artifact@v4
        with:
          name: windows-wheels
          path: artifacts/wheels
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Wheels to Release
        # softprops/action-gh-release supports `files:` input to attach assets
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/wheels/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
